import "@azure-tools/typespec-azure-core";
import "@azure-tools/typespec-azure-resource-manager";
import "@typespec/openapi";
import "@typespec/rest";
import "@typespec/http";
import "@azure-tools/typespec-azure-resource-manager";

import "./hciCommon.tsp";

using TypeSpec.Rest;
using Azure.ResourceManager;
using TypeSpec.Http;
using TypeSpec.OpenAPI;
using Azure.Core;


@doc("A EdgeDevice")
@armProviderNamespace("Private.AzureStackHCI")
namespace Private.AzureStackHCI;

#suppress "@azure-tools/typespec-azure-resource-manager/arm-resource-provisioning-state" ""
model EdgeDevice is Azure.ResourceManager.ExtensionResource<{}> {
  ...ResourceNameParameter<
    Resource = EdgeDevice,
    KeyName = "edgeDeviceName",
    SegmentName = "edgeDevices",
    NamePattern = "^[a-zA-Z0-9-]{3,24}$"
  >;
}

// FIXME: EdgeDeviceJob has no properties property
/**
 * Jobs resource
 */
#suppress "@azure-tools/typespec-azure-resource-manager/arm-resource-provisioning-state" ""
@doc("EdgeDevice Jobs resource")
@parentResource(EdgeDevice)
@discriminator("kind")
model EdgeDeviceJob is Azure.ResourceManager.ExtensionResource<{}> {
  ...ResourceNameParameter<
    Resource = EdgeDeviceJob,
    KeyName = "jobsName",
    SegmentName = "jobs",
    NamePattern = "^[a-zA-Z0-9-]{3,24}$"
  >;

  /**
   * Edge Solution type to support polymorphic resource.
   */
  #suppress "@azure-tools/typespec-azure-resource-manager/arm-resource-invalid-envelope-property" ""
  @visibility("read", "create")
  kind: DeviceType;
}

@armResourceOperations
interface EdgeDeviceJobs {
  /**
   * Get a EdgeDeviceJob
   */
  get is ArmResourceRead<EdgeDeviceJob>;

  /**
   * Create a EdgeDeviceJob
   */
  createOrUpdate is ArmResourceCreateOrReplaceAsync<EdgeDeviceJob>;

  /**
   * Delete a EdgeDeviceJob
   */
  delete is ArmResourceDeleteWithoutOkAsync<EdgeDeviceJob>;

  /**
   * List EdgeDeviceJob resources by EdgeDevice
   */
  listByEdgeDevice is ArmResourceListByParent<EdgeDeviceJob>;
}

@@doc(EdgeDeviceJob.name, "Name of EdgeDevice Job");

///////////////////models///////////

/**
 * Edge device type based on host OS installed.
 */
union DeviceType {
  string,

  /**
   * Arc-enabled edge device with HCI OS.
   */
  HCI: "HCI",

  /**
   * Arc-enabled edge device with WindowsServer OS.
   */
  WindowsServer: "WindowsServer",

  /**
   * Arc-enabled edge device with WindowsIoT OS.
   */
  WindowsIoT: "WindowsIoT",

  /**
   * Arc-enabled edge device with AzureLinux OS.
   */
  AzureLinux: "AzureLinux",

  /**
   * Arc-enabled edge device with UbuntuLinux OS.
   */
  UbuntuLinux: "UbuntuLinux",
}

/**
 * The status of log collection.
 */
/**
 * Represents the status of a log collection operation.
 */
union LogCollectionStatus {
  /**
   * A custom status provided as a string.
   */
  string,

  /**
   * Indicates that no log collection operation has been initiated.
   */
  None: "None",

  /**
   * Indicates that the log collection operation is currently in progress.
   */
  InProgress: "InProgress",

  /**
   * Indicates that the log collection operation has failed.
   */
  Failed: "Failed",

  /**
   * Indicates that the log collection operation has completed successfully.
   */
  Succeeded: "Succeeded",
}

/**
 * Job Type supported by Azure Linux Edge Devices.
 */
union AzureLinuxEdgeDeviceJobType {
  string,

  /**
   * Job to collect logs from the device.
   */
  CollectLog: "CollectLog",

  /**
   * Job to provide remote support to the device.
   */
  RemoteSupport: "RemoteSupport",
}

/**
 * Defines the level of remote support access granted.
 */
union RemoteSupportAccessLevel {
  /**
   * A custom access level provided as a string.
   */
  string,

  /**
   * No remote support access is granted.
   */
  None: "None",

  /**
   * Access is limited to diagnostics information only.
   */
  Diagnostics: "Diagnostics",

  /**
   * Access includes diagnostics information and the ability to perform repairs.
   */
  DiagnosticsAndRepair: "DiagnosticsAndRepair",
}

/**
 * Defines the type of remote support action to be performed on an edge device.
 */
union RemoteSupportType {
  /**
   * A custom action type provided as a string.
   */
  string,

  /**
   * Enables remote support for the edge device.
   */
  Enable: "Enable",

  /**
   * Revokes previously granted remote support access for the edge device.
   */
  Revoke: "Revoke",
}

/**
 * Job Type supported.
 */
union HciEdgeDeviceJobType {
  string,

  /**
   * Job to collect logs from the device.
   */
  CollectLog: "CollectLog",

  /**
   * Job to provide remote support to the device.
   */
  RemoteSupport: "RemoteSupport",
}

/**
 * Common Job Types supported.
 */
union EdgeDeviceJobType {
  string,

  /**
   * Job to collect logs from the device.
   */
  CollectLog: "CollectLog",

  /**
   * Job to provide remote support to the device.
   */
  RemoteSupport: "RemoteSupport",

  /**
   * Job to establish a remote connection to the device.
   */
  RemoteConnect: "RemoteConnect",
}

/**
 * Azure Linux Collect Log Job Properties.
 */
model AzureLinuxCollectLogJobProperties
  extends AzureLinuxEdgeDeviceJobProperties {
  ...CollectLogJobProperties;

  /**
   * Job Type to support polymorphic resource.
   */
  jobType: AzureLinuxEdgeDeviceJobType.CollectLog;
}

/**
 * Represents the reported properties of a log collection job.
 */
model LogCollectionReportedProperties {
  /**
   * The percentage of the job that is complete.
   */
  @visibility("read")
  percentComplete?: int32;

  /**
   * Validation status of job.
   */
  @visibility("read")
  validationStatus?: EceActionStatus;

  /**
   * Deployment status of job.
   */
  @visibility("read")
  deploymentStatus?: EceActionStatus;

  /**
   * Details of the log collection session.
   */
  @visibility("read")
  @extension("x-ms-identifiers", ["correlationId"])
  logCollectionSessionDetails?: LogCollectionSession[];
}

/**
 * Represents a session for collecting logs from an edge device.
 */
model LogCollectionSession {
  /**
   * The timestamp when log collection started, in ISO 8601 format.
   */
  @visibility("read")
  startTime?: string;

  /**
   * The timestamp when log collection ended, in ISO 8601 format.
   */
  @visibility("read")
  endTime?: string;

  /**
   * The total time logs were collected for, in ISO 8601 duration format.
   */
  @visibility("read")
  timeCollected?: string;

  /**
   * The size of the collected logs in bytes.
   */
  @visibility("read")
  logSize?: int32;

  /**
   * The status of the log collection session.
   */
  @visibility("read")
  status?: LogCollectionStatus;

  /**
   * A unique identifier for correlating this log collection session with other operations or sessions.
   */
  @visibility("read")
  correlationId?: string;
}
/**
 * Edge device job properties
 */
@discriminator("jobType")
model AzureLinuxEdgeDeviceJobProperties {
  ...EdgeDeviceJobProperties;

  @doc("Job Type to support polymorphic resource.")
  @extension("x-ms-mutability", ["create", "read"])
  jobType: AzureLinuxEdgeDeviceJobType;
}

/**
 * Edge device job properties
 */
model EdgeDeviceJobProperties {
  /**
   * Deployment mode to trigger job.
   */
  deploymentMode?: DeploymentMode;

  /**
   * Job provisioning state
   */
  @visibility("read")
  provisioningState?: ProvisioningState;

  /**
   * Unique, immutable job id.
   */
  @visibility("read")
  jobId?: uuid;

  /**
   * The UTC date and time at which the job started.
   */
  @visibility("read")
  startTimeUtc?: utcDateTime;

  /**
   * The UTC date and time at which the job completed.
   */
  @visibility("read")
  endTimeUtc?: utcDateTime;

  /**
   * Status of Edge device job.
   */
  @visibility("read")
  status?: JobStatus;

  /**
   * Reported properties for job
   */
  @visibility("read")
  reportedProperties?: EdgeDeviceJobReportedProperties;
}

/**
 * Reported Properties for  job triggered from cloud.
 */
model EdgeDeviceJobReportedProperties {
  /**
   * The percentage of the job that is complete.
   */
  @visibility("read")
  percentComplete?: int32;

  /**
   * Validation status of job.
   */
  @visibility("read")
  validationStatus?: EceActionStatus;

  /**
   * Deployment status of job.
   */
  @visibility("read")
  deploymentStatus?: EceActionStatus;
}

/**
 * Edge device job for Azure Linux solution.
 */
model AzureLinuxEdgeDeviceJob extends EdgeDeviceJob {
  /**
   * Edge device job properties
   */
  properties: AzureLinuxEdgeDeviceJobProperties;

  /**
   * Edge Solution type to support polymorphic resource.
   */
  kind: DeviceType.AzureLinux;
}

/**
 * Represents the properties of an Azure Linux Remote Support job.
 */
model AzureLinuxRemoteSupportJobProperties
  extends AzureLinuxEdgeDeviceJobProperties {
  ...RemoteSupportJobProperties;

  /**
   * Job Type to support polymorphic resource.
   */
  jobType: AzureLinuxEdgeDeviceJobType.RemoteSupport;
}

/**
 * Represents the reported properties of a remote support job.
 */
model RemoteSupportReportedProperties {
  /**
   * The percentage of the job that is complete.
   */
  @visibility("read")
  percentComplete?: int32;

  /**
   * Validation status of job.
   */
  @visibility("read")
  validationStatus?: EceActionStatus;

  /**
   * Deployment status of job.
   */
  @visibility("read")
  deploymentStatus?: EceActionStatus;

  /**
   * Optional settings for configuring the node for remote support.
   */
  @visibility("read")
  @extension("x-ms-identifiers", ["arcResourceId"])
  nodeSettings?: RemoteSupportNodeSettings[];

  /**
   * Details of the remote support session.
   */
  @visibility("read")
  sessionDetails?: RemoteSupportSession;
}

/**
 * Represents the settings of a remote support node.
 */
model RemoteSupportNodeSettings {
  /**
   * The resource ID of the Azure Arc enabled server.
   */
  @visibility("read")
  arcResourceId?: string;

  /**
   * The state of the remote support node.
   */
  @visibility("read")
  state?: string;

  /**
   * The timestamp when the node settings were created, in UTC.
   */
  @visibility("read")
  createdAt?: utcDateTime;

  /**
   * The timestamp when the node settings were last updated, in UTC.
   */
  @visibility("read")
  updatedAt?: utcDateTime;

  /**
   * The current connection status of the remote support session.
   */
  @visibility("read")
  connectionStatus?: string;

  /**
   * The error message, if any, from the last connection attempt.
   */
  @visibility("read")
  connectionErrorMessage?: string;

  /**
   * The location where the session transcript is stored.
   */
  @visibility("read")
  transcriptLocation?: string;
}

/**
 * Represents a remote support session.
 */
model RemoteSupportSession {
  /**
   * The start time of the remote support session, in UTC.
   */
  @visibility("read")
  sessionStartTime?: utcDateTime;

  /**
   * The end time of the remote support session, in UTC.
   */
  @visibility("read")
  sessionEndTime?: utcDateTime;

  /**
   * The name of the node for which the session was initiated.
   */
  @visibility("read")
  nodeName?: string;

  /**
   * The duration of the session in minutes.
   */
  @visibility("read")
  duration?: int32;

  /**
   * The level of access granted during the remote support session.
   */
  @visibility("read")
  accessLevel?: RemoteSupportAccessLevel;
}

/**
 * Represents the properties of a log collection job.
 */
model CollectLogJobProperties {
  /**
   * From date for log collection.
   */
  fromDate: utcDateTime;

  /**
   * To date for log collection.
   */
  toDate: utcDateTime;

  /**
   * To date for log collection.
   */
  @visibility("read")
  lastLogGenerated?: utcDateTime;

  /**
   * log collection job reported properties.
   */
  @visibility("read")
  reportedProperties?: LogCollectionReportedProperties;
}

/**
 * Represents the properties of an HCI Collect Log job.
 */
model HciCollectLogJobProperties extends HciEdgeDeviceJobProperties {
  ...CollectLogJobProperties;

  /**
   * Job Type to support polymorphic resource.
   */
  jobType: HciEdgeDeviceJobType.CollectLog;
}

/**
 * HCI Edge device job properties
 */
@discriminator("jobType")
@doc("HCI Edge device job properties")
model HciEdgeDeviceJobProperties {
  ...EdgeDeviceJobProperties;

  @doc("Job Type to support polymorphic resource.")
  @extension("x-ms-mutability", ["create", "read"])
  jobType: HciEdgeDeviceJobType;
}

/**
 * Edge device job for Azure Stack HCI solution.
 */
model HciEdgeDeviceJob extends EdgeDeviceJob {
  /**
   * HCI Edge device job properties
   */
  properties: HciEdgeDeviceJobProperties;

  /**
   * Edge Solution type to support polymorphic resource.
   */
  kind: "HCI";
}

/**
 * Represents the properties of a remote support job for HCI.
 */
model HciRemoteSupportJobProperties extends HciEdgeDeviceJobProperties {
  ...RemoteSupportJobProperties;

  /**
   * Job Type to support polymorphic resource.
   */
  jobType: HciEdgeDeviceJobType.RemoteSupport;
}

/**
 * Represents the properties of a remote support job.
 */
model RemoteSupportJobProperties {
  /**
   * Remote support access level.
   */
  accessLevel: RemoteSupportAccessLevel;

  /**
   * Remote support expiration timestamp.
   */
  expirationTimestamp: utcDateTime;

  /**
   * Remote support type.
   */
  type: RemoteSupportType;

  /**
   * log collection job reported properties.
   */
  @visibility("read")
  reportedProperties?: RemoteSupportReportedProperties;
}
