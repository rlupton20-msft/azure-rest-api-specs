import "@typespec/rest";
import "@typespec/http";
import "@azure-tools/typespec-azure-core";
import "@azure-tools/typespec-azure-resource-manager";
import "@typespec/versioning";
import "./commonmodels.tsp";
import "./main.tsp";

using TypeSpec.Rest;
using TypeSpec.Http;
using Azure.ResourceManager;
using TypeSpec.Versioning;

namespace Microsoft.ChangeSafety;

@doc("Defines the progression of a change using these child resources, with ChangeState parent resource.")
@parentResource(ChangeState)
model StageProgression is ProxyResource<StageProgressionProperties> {
  @doc("name of the stageProgression")
  @key("stageProgressionName")
  @segment("stageProgressions")
  @pattern("^[a-zA-Z0-9-|]{3,100}$")
  @minLength(3)
  @maxLength(100)
  @path
  name: string;
}

@doc("Detailed properties of the StageProgression resource.")
model StageProgressionProperties {
  @visibility(Lifecycle.Read)
  @doc("The status of the last operation.")
  provisioningState?: ProvisioningState;

  @visibility(Lifecycle.Read, Lifecycle.Create, Lifecycle.Update)
  @doc("Stage name relevant to hierarchical StageMap.")
  @minLength(3)
  @maxLength(200)
  stageReference: string;

  @visibility(Lifecycle.Read, Lifecycle.Create, Lifecycle.Update)
  @doc("StageProgression resource state.")
  @removed(Versions.v2025_09_01_preview)
  state: StageProgressionState;

  @visibility(Lifecycle.Read, Lifecycle.Create, Lifecycle.Update)
  @doc("StageProgression resource status.")
  @added(Versions.v2025_09_01_preview)
  status: StageProgressionState;

  @visibility(Lifecycle.Read)
  @renamedFrom(Versions.v2025_07_01_preview, "sequence")
  @removed(Versions.v2025_07_01_preview)
  @doc("The sequence of the stage within the ChangeStage parent resource.")
  @minValue(1)
  sequenceOld?: int32;

  @visibility(Lifecycle.Read, Lifecycle.Create, Lifecycle.Update)
  @renamedFrom(Versions.v2025_09_01_preview, "sequence")
  @removed(Versions.v2025_09_01_preview)
  @doc("The sequence of the stage within the ChangeStage parent resource.")
  @minValue(1)
  @added(Versions.v2025_07_01_preview)
  sequenceOld1?: int32;

  @visibility(Lifecycle.Read)
  @doc("The sequence of the stage within the ChangeStage parent resource.")
  @minValue(1)
  @added(Versions.v2025_09_01_preview)
  sequence?: int32;

  #suppress "@azure-tools/typespec-autorest/union-unsupported" "Suppressing warning: We need the Parameters to be strong type. So need to provide all the supported types which are string & int for now."
  #suppress "@azure-tools/typespec-azure-resource-manager/arm-no-record" "Suppressing the warning: We need list of parameters in key:value format."
  @doc("Parameters to apply on the change of that stage. Key value pairs of parameter and values.")
  @visibility(Lifecycle.Read, Lifecycle.Create, Lifecycle.Update)
  @removed(Versions.v2025_07_01_preview)
  parameterValues: Record<string | int32>;

  #suppress "@azure-tools/typespec-azure-resource-manager/arm-no-record" "Stage specific key value pairs of parameter names & their values, which can be any type"
  @doc("Variables to apply on the change of that stage. Key value pairs supporting any JSON values.")
  @visibility(Lifecycle.Read, Lifecycle.Create, Lifecycle.Update)
  @added(Versions.v2025_07_01_preview)
  stageVariables?: Record<unknown>;

  @visibility(Lifecycle.Read, Lifecycle.Create, Lifecycle.Update)
  @doc("Comments about the update to the resource.")
  @maxLength(2000)
  comments?: string;

  @visibility(Lifecycle.Read, Lifecycle.Create, Lifecycle.Update)
  @doc("Collection of related links for the change.")
  @renamedFrom(Versions.v2025_09_01_preview, "links")
  @added(Versions.v2025_07_01_preview)
  @removed(Versions.v2025_09_01_preview)
  links0701?: ChangeLinks;

  @visibility(Lifecycle.Read, Lifecycle.Create, Lifecycle.Update)
  @doc("Collection of related links for the change.")
  @added(Versions.v2025_09_01_preview)
  links?: Link[];

  #suppress "@azure-tools/typespec-azure-resource-manager/no-empty-model" "Defines a flexible placeholder for stage specific meta data for diverse orchestration and change scenarios."
  @visibility(Lifecycle.Read, Lifecycle.Create, Lifecycle.Update)
  @doc("Additional metadata for the stageProgression resource.")
  @added(Versions.v2025_07_01_preview)
  additionalData?: {};

  #suppress "@azure-tools/typespec-azure-resource-manager/arm-no-record" "Key value pairs of parameter names & their values for the current Stage.Value can be any type, hence using Unknown type."
  @doc("Stage specific key value pairs of parameter names & their values for the current Stage, If any.")
  @visibility(Lifecycle.Read, Lifecycle.Create, Lifecycle.Update)
  @added(Versions.v2025_09_01_preview)
  parameters?: Record<unknown>;
}

@doc("Indicates the current status of the progression of the change within the stage.")
union StageProgressionState {
  string,

  @doc("Change is initialized to be applied within the stage.")
  Initialized: "Initialized",

  @doc("Change is being applied within the stage.")
  InProgress: "InProgress",

  @doc("Change has successfully been applied to the stage.")
  Completed: "Completed",

  @doc("Change apply operation was abandoned.")
  @removed(Versions.v2025_07_01_preview)
  Abandoned: "Abandoned",

  @doc("Change apply operation was cancelled.")
  @added(Versions.v2025_07_01_preview)
  Cancelled: "Cancelled",

  @doc("Change apply operation was paused.")
  Paused: "Paused",

  @doc("Change apply operation was failed.")
  Failed: "Failed",

  @doc("Change is not applied to the stage.")
  Skipped: "Skipped",
}

@doc("Azure resource Id of a ChangeState.")
scalar StageProgressionResourceId
  extends Azure.Core.armResourceIdentifier<[
    {
      type: "Microsoft.ChangeSafety/changeStates/stageProgressions",
    }
  ]>;

@armResourceOperations
@doc("The operations of the stageProgression resource.")
interface StageProgressions {
  get is ArmResourceRead<StageProgression>;

  @added(Versions.v2025_09_01_preview)
  getAtSubscriptionLevel is ArmResourceRead<
    StageProgression,
    {
      ...ApiVersionParameter;
      ...SubscriptionIdParameter;
    }
  >;

  createOrUpdate is ArmResourceCreateOrReplaceSync<StageProgression>;
  createOrUpdateAtSubscriptionLevel is ArmResourceCreateOrReplaceSync<
    StageProgression,
    {
      ...ApiVersionParameter;
      ...SubscriptionIdParameter;
    }
  >;

  delete is ArmResourceDeleteSync<StageProgression>;
  deleteAtSubscriptionLevel is ArmResourceDeleteSync<
    StageProgression,
    {
      ...ApiVersionParameter;
      ...SubscriptionIdParameter;
    }
  >;

  update is ArmResourcePatchSync<StageProgression, StageProgressionProperties>;
  updateAtSubscriptionLevel is ArmResourcePatchSync<
    StageProgression,
    StageProgressionProperties,
    {
      ...ApiVersionParameter;
      ...SubscriptionIdParameter;
    }
  >;

  listByParent is ArmResourceListByParent<StageProgression>;
  listByParentAtSubscriptionLevel is ArmResourceListByParent<
    StageProgression,
    {
      ...ApiVersionParameter;
      ...SubscriptionIdParameter;
    }
  >;

  @doc("Retrieve the audit trail action, for a StageProgression.")
  @action("retrieveAuditTrail")
  @added(Versions.v2025_09_01_preview)
  retrieveAuditTrail is ArmResourceActionSync<
    StageProgression,
    void,
    RetrieveAuditTrailResponse
  >;

  @doc("Retrieve the audit trail action, for a StageProgression at subscription level.")
  @action("retrieveAuditTrail")
  @added(Versions.v2025_09_01_preview)
  retrieveAuditTrailAtSubscriptionLevel is ArmResourceActionSync<
    StageProgression,
    void,
    RetrieveAuditTrailResponse,
    {
      ...ApiVersionParameter;
      ...SubscriptionIdParameter;
    }
  >;
}
